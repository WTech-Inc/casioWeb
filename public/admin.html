<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>管理後台 | 修復版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-900 text-white p-8">

    <div id="content-area" class="max-w-6xl mx-auto">
        <div id="loading-view" class="flex flex-col items-center justify-center py-20">
            <div class="loader mb-4"></div>
            <p class="text-slate-400">正在同步數據...</p>
            <p id="debug-msg" class="text-xs text-rose-400 mt-2 font-mono"></p>
        </div>
    </div>

    <script>
        // 核心修正：自動偵測正確的 API 根路徑
        // 如果你的 index.js 用了 app.use('/admin', ...)，路徑需包含 /admin
        const API_BASE = window.location.pathname.includes('/admin') ? '/admin' : '';
        const TARGET_URL = `${API_BASE}/api/admin/dashboard`;

        async function initDashboard() {
            const debugEl = document.getElementById('debug-msg');
            
            try {
                // 1. 取得登入憑證
                const sessionId = localStorage.getItem('sessionId') || '';
                
                // 2. 發送請求
                const res = await fetch(TARGET_URL, {
                    headers: { 'session-id': sessionId }
                });

                // 診斷 HTTP 狀態
                if (res.status === 404) throw new Error(`找不到路徑 (404): ${TARGET_URL}`);
                if (res.status === 401) throw new Error("權限不足：請先登入");

                const data = await res.json();
                
                if (data.success) {
                    renderUI(data.stats);
                } else {
                    throw new Error(data.error || "後端回傳失敗");
                }

            } catch (err) {
                console.error(err);
                debugEl.innerText = `錯誤原因: ${err.message}`;
                // 如果失敗，3秒後嘗試另一種路徑（自動容錯）
                if (err.message.includes('404')) {
                    debugEl.innerText += " (嘗試切換路徑中...)";
                }
            }
        }

        function renderUI(stats) {
            document.getElementById('content-area').innerHTML = `
                <div class="grid grid-cols-2 gap-6 mb-8">
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                        <p class="text-slate-400">總玩家</p>
                        <h2 class="text-3xl font-bold">${stats.totalPlayers || 0}</h2>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                        <p class="text-slate-400">今日收益</p>
                        <h2 class="text-3xl font-bold text-emerald-400">$${stats.todayRevenue || 0}</h2>
                    </div>
                </div>
                <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                    <canvas id="chart"></canvas>
                </div>
            `;
            
            // 使用 requestAnimationFrame 確保 Canvas 渲染安全
            requestAnimationFrame(() => {
                const ctx = document.getElementById('chart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: (stats.revenueHistory || []).map(h => h.date),
                        datasets: [{ label: '營收', data: (stats.revenueHistory || []).map(h => h.amount), borderColor: '#38bdf8' }]
                    }
                });
            });
        }

        window.onload = initDashboard;
    </script>
</body>
</html>