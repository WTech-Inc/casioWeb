<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>快活娛樂城 | 核心權限控制台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');
        body { background-color: #020617; font-family: 'Plus Jakarta Sans', sans-serif; color: #e2e8f0; }
        .terminal-font { font-family: 'Fira Code', monospace; }
        .glass { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(56, 189, 248, 0.1); }
        .neon-border { border: 1px solid rgba(56, 189, 248, 0.3); box-shadow: 0 0 15px rgba(56, 189, 248, 0.1); }
        .nav-active { background: linear-gradient(90deg, rgba(56, 189, 248, 0.15) 0%, transparent 100%); border-left: 4px solid #38bdf8; color: #38bdf8; }
        /* 自定義按鈕音效感(視覺) */
        .btn-action { transition: all 0.1s active { transform: scale(0.95); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-80 bg-[#070d19] border-r border-slate-800 flex flex-col">
        <div class="p-8">
            <div class="flex items-center space-x-3 mb-2">
                <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                <span class="text-xs font-bold text-slate-500 tracking-widest uppercase">Live System</span>
            </div>
            <h1 class="text-2xl font-black text-white italic tracking-tighter">JOYFUL <span class="text-sky-500">ADMIN</span></h1>
        </div>

        <nav class="flex-1 px-4">
            <div class="text-[10px] text-slate-600 font-bold px-4 mb-2 uppercase">主矩陣</div>
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-active w-full flex items-center px-4 py-4 mb-1 rounded-r-xl transition text-sm">
                <i class="fas fa-microchip mr-3"></i> 數據儀表板
            </button>
            <button onclick="switchTab('users')" id="nav-users" class="w-full flex items-center px-4 py-4 mb-1 rounded-r-xl text-slate-400 hover:text-sky-400 transition text-sm">
                <i class="fas fa-user-secret mr-3"></i> 玩家大廳控制
            </button>
            <div class="text-[10px] text-slate-600 font-bold px-4 mt-6 mb-2 uppercase">數據核心</div>
            <button onclick="switchTab('games')" id="nav-games" class="w-full flex items-center px-4 py-4 mb-1 rounded-r-xl text-slate-400 hover:text-sky-400 transition text-sm">
                <i class="fas fa-dice mr-3"></i> 賠率與圖標管理
            </button>
            <button onclick="switchTab('database')" id="nav-database" class="w-full flex items-center px-4 py-4 mb-1 rounded-r-xl text-slate-400 hover:text-sky-400 transition text-sm">
                <i class="fas fa-database mr-3"></i> 資料庫維護
            </button>
        </nav>

        <div class="p-6 bg-slate-900/40">
            <button onclick="logout()" class="w-full py-3 rounded-lg border border-rose-500/30 text-rose-500 text-sm font-bold hover:bg-rose-500 hover:text-white transition shadow-lg shadow-rose-500/5">
                <i class="fas fa-lock-open mr-2"></i> 終止會話
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col">
        <header class="h-20 glass flex items-center justify-between px-10">
            <div class="flex items-center space-x-4">
                <i class="fas fa-terminal text-sky-500"></i>
                <div class="terminal-font text-xs text-sky-500/70" id="terminal-path">joyful-server:~/admin/dashboard</div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <p class="text-xs text-slate-500">Node.js SQLite V3</p>
                    <p class="text-xs font-bold text-white">管理者: Root</p>
                </div>
                <div class="w-10 h-10 bg-sky-500/20 rounded-full flex items-center justify-center border border-sky-500/50">
                    <i class="fas fa-user-shield text-sky-400"></i>
                </div>
            </div>
        </header>

        <div id="content-area" class="flex-1 overflow-y-auto p-8 space-y-6">
            </div>
    </main>

    <div id="modal-overlay" class="fixed inset-0 bg-black/90 backdrop-blur-md z-50 hidden flex items-center justify-center">
        <div class="glass neon-border w-[450px] p-8 rounded-3xl" id="modal-content"></div>
    </div>

    <script>
        const BASE_URL = '/api/admin'; // 嚴格對齊你的要求
        const getHeaders = () => ({ 'session-id': localStorage.getItem('sessionId'), 'Content-Type': 'application/json' });

        // 1. 初始化
        window.onload = () => switchTab('dashboard');

        // 2. 切換邏輯
        async function switchTab(tab) {
            document.querySelectorAll('nav button').forEach(b => b.className = b.className.replace('nav-active', '').replace('text-sky-400', 'text-slate-400'));
            document.getElementById(`nav-${tab}`).classList.add('nav-active');
            document.getElementById('terminal-path').innerText = `joyful-server:~/admin/${tab}`;

            const container = document.getElementById('content-area');
            container.innerHTML = '<div class="h-full flex items-center justify-center"><i class="fas fa-circle-notch fa-spin text-4xl text-sky-500"></i></div>';

            try {
                const res = await fetch(`${BASE_URL}/dashboard`, { headers: getHeaders() });
                const data = await res.json();
                
                if (tab === 'dashboard') renderDashboard(data.stats);
                else if (tab === 'users') renderUsers(data.recentUsers);
                else if (tab === 'games') renderGames(); // 需呼叫 settings/stats API
                else if (tab === 'database') renderDatabase();
            } catch (err) {
                container.innerHTML = `<div class="p-10 glass border-rose-500/50 text-rose-500">系統中斷: ${err.message}</div>`;
            }
        }

        // --- 儀表板渲染 ---
        function renderDashboard(stats) {
            document.getElementById('content-area').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="glass p-6 rounded-2xl relative overflow-hidden">
                        <div class="text-slate-500 text-[10px] font-bold uppercase mb-1">今日流動資金</div>
                        <div class="text-3xl font-black text-emerald-400">$${stats.todayRevenue.toLocaleString()}</div>
                        <i class="fas fa-chart-bar absolute -right-2 -bottom-2 text-6xl opacity-5"></i>
                    </div>
                    <div class="glass p-6 rounded-2xl">
                        <div class="text-slate-500 text-[10px] font-bold uppercase mb-1">活躍會籍數</div>
                        <div class="text-3xl font-black text-sky-400">${stats.totalPlayers}</div>
                    </div>
                    <div class="glass p-6 rounded-2xl border-amber-500/20">
                        <div class="text-slate-500 text-[10px] font-bold uppercase mb-1">資料庫負載</div>
                        <div class="text-3xl font-black text-amber-500 text-sm italic">NORMAL (Memory Mode)</div>
                    </div>
                </div>
                <div class="glass p-8 rounded-3xl h-[400px]">
                    <h3 class="text-sm font-bold text-slate-400 mb-4 tracking-widest"><i class="fas fa-wave-square mr-2"></i> 24H 營收波動圖譜</h3>
                    <canvas id="mainChart"></canvas>
                </div>
            `;
            initChart(stats.revenueHistory);
        }

        // --- 玩家管理：好玩的功能在這裡 ---
        function renderUsers(users) {
            document.getElementById('content-area').innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold tracking-tighter">玩家大廳陣列</h3>
                    <div class="text-xs text-slate-500">點擊玩家進行「特殊干預」</div>
                </div>
                <div class="glass rounded-2xl overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-900/80 text-slate-500 text-[10px] uppercase">
                            <tr>
                                <th class="p-5">玩家特徵 (Username)</th>
                                <th class="p-5">資產 (Chips)</th>
                                <th class="p-5">登錄序號</th>
                                <th class="p-5">快捷權限</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(u => `
                                <tr class="border-b border-slate-800/50 hover:bg-sky-500/5 transition">
                                    <td class="p-5 font-bold text-white">${u.username}</td>
                                    <td class="p-5 text-emerald-400 font-mono">$${u.chips.toLocaleString()}</td>
                                    <td class="p-5 text-slate-500 text-xs">${u.player_id}</td>
                                    <td class="p-5 flex space-x-2">
                                        <button onclick="instantRich('${u.player_id}', '${u.username}')" class="px-3 py-1 bg-amber-500/10 text-amber-500 border border-amber-500/20 rounded-md text-xs hover:bg-amber-500 hover:text-white transition">一鍵暴富</button>
                                        <button onclick="punish('${u.player_id}')" class="px-3 py-1 bg-rose-500/10 text-rose-500 border border-rose-500/20 rounded-md text-xs hover:bg-rose-500 hover:text-white transition">歸零懲罰</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // --- 遊戲圖標管理 ---
        async function renderGames() {
            const res = await fetch(`${BASE_URL}/settings/stats`, { headers: getHeaders() });
            const { stats } = await res.json();
            document.getElementById('content-area').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass p-8 rounded-3xl">
                        <h3 class="font-bold text-sky-400 mb-6 uppercase tracking-widest text-xs">圖標分類分佈</h3>
                        <div class="space-y-4">
                            ${stats.iconsByCategory.map(c => `
                                <div>
                                    <div class="flex justify-between text-xs mb-1">
                                        <span>${c.category}</span>
                                        <span>${c.count} 項</span>
                                    </div>
                                    <div class="w-full h-1 bg-slate-800 rounded-full overflow-hidden">
                                        <div class="h-full bg-sky-500" style="width: ${(c.count / stats.totalIcons * 100)}%"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="glass p-8 rounded-3xl border-purple-500/20">
                         <h3 class="font-bold text-purple-400 mb-4 uppercase tracking-widest text-xs">遊戲伺服器核心</h3>
                         <div class="flex items-center justify-between p-4 bg-slate-900 rounded-xl mb-2">
                            <span class="text-sm">百家樂伺服器</span>
                            <span class="text-[10px] px-2 py-1 bg-emerald-500/10 text-emerald-500 rounded">HEALTHY</span>
                         </div>
                         <div class="flex items-center justify-between p-4 bg-slate-900 rounded-xl">
                            <span class="text-sm">老虎機亂數生成器</span>
                            <span class="text-[10px] px-2 py-1 bg-emerald-500/10 text-emerald-500 rounded">HEALTHY</span>
                         </div>
                    </div>
                </div>
            `;
        }

        // --- 資料庫維護：好玩點的日誌監控 ---
        function renderDatabase() {
            document.getElementById('content-area').innerHTML = `
                <div class="glass p-8 rounded-3xl mb-6">
                    <h3 class="text-xs font-bold text-slate-500 uppercase mb-4 tracking-widest">實時操作日誌 (Read-only)</h3>
                    <div class="bg-black/50 p-6 rounded-xl terminal-font text-[11px] text-emerald-500/80 h-48 overflow-y-auto space-y-1">
                        <div>[${new Date().toLocaleTimeString()}] INFO: 資料庫連接池初始化完成...</div>
                        <div>[${new Date().toLocaleTimeString()}] WARN: 偵測到 127.0.0.1 嘗試存取管理權限...</div>
                        <div class="animate-pulse">[${new Date().toLocaleTimeString()}] SUCCESS: Root 管理員進入控制矩陣...</div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button class="glass p-6 rounded-2xl hover:border-sky-500 transition text-left group">
                        <i class="fas fa-file-export text-sky-500 mb-2"></i>
                        <div class="text-sm font-bold">下載 SQL 鏡像備份</div>
                    </button>
                    <button class="glass p-6 rounded-2xl hover:border-rose-500 transition text-left group">
                        <i class="fas fa-trash-alt text-rose-500 mb-2"></i>
                        <div class="text-sm font-bold">強制清除所有無效 Session</div>
                    </button>
                </div>
            `;
        }

        // --- 特殊操作功能 ---
        function instantRich(id, name) {
            openModal(`
                <h3 class="text-xl font-black italic mb-4">給予「一鍵暴富」福利</h3>
                <p class="text-sm text-slate-400 mb-6">將為玩家 <span class="text-sky-400 font-bold">${name}</span> 注入 <span class="text-emerald-400">$10,000,000</span> 籌碼。</p>
                <div class="flex space-x-3">
                    <button onclick="closeModal()" class="flex-1 py-3 rounded-xl bg-slate-800 text-xs uppercase font-bold">取消</button>
                    <button onclick="executeAction('${id}', 10000000)" class="flex-1 py-3 rounded-xl bg-emerald-500 text-black text-xs font-black uppercase">立即注入</button>
                </div>
            `);
        }

        function punish(id) {
            openModal(`
                <h3 class="text-xl font-black italic mb-4 text-rose-500">歸零懲罰</h3>
                <p class="text-sm text-slate-400 mb-6">這將清空玩家的所有資產。確定執行？</p>
                <div class="flex space-x-3">
                    <button onclick="closeModal()" class="flex-1 py-3 rounded-xl bg-slate-800 text-xs uppercase font-bold">取消</button>
                    <button onclick="executeAction('${id}', 0)" class="flex-1 py-3 rounded-xl bg-rose-600 text-white text-xs font-black uppercase">確認懲罰</button>
                </div>
            `);
        }

        async function executeAction(playerId, amount) {
            // 注意：這裡假設你在 admin.js 有實作 /update-chips 路由
            try {
                const res = await fetch(`${BASE_URL}/update-chips`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ playerId, amount })
                });
                const data = await res.json();
                if (data.success) {
                    alert("操作成功，矩陣已更新。");
                    closeModal();
                    switchTab('users');
                } else {
                    alert("操作失敗: " + data.error);
                }
            } catch (e) {
                alert("伺服器拒絕連線");
            }
        }

        // --- 通用工具 ---
        function openModal(html) {
            document.getElementById('modal-content').innerHTML = html;
            document.getElementById('modal-overlay').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); }
        function initChart(history = []) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: history.map(h => h.date),
                    datasets: [{
                        label: 'Revenue',
                        data: history.map(h => h.amount),
                        borderColor: '#38bdf8',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(56, 189, 248, 0.05)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: 'rgba(255,255,255,0.05)' } }, x: { display: false } } }
            });
        }
        function logout() { localStorage.removeItem('sessionId'); location.href = '/login.html'; }
    </script>
</body>
</html>