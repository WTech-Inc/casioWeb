<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å¾Œå° | ç¾ä»£åŒ–å„€è¡¨æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #020617; color: #f8fafc; }
        .glass-card { background: rgba(30, 41, 59, 0.4); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .chart-container { position: relative; height: 350px; width: 100%; }
        .loader { border: 3px solid rgba(56, 189, 248, 0.2); border-top: 3px solid #38bdf8; border-radius: 50%; width: 24px; height: 24px; animate: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col">
        <div class="p-6 text-xl font-bold text-sky-400 flex items-center">
            <span class="mr-2">ğŸ”§</span> ç®¡ç†ä¸­å¿ƒ
        </div>
        <nav class="flex-1 px-4 space-y-2">
            <button onclick="loadDashboard()" class="w-full text-left px-4 py-3 rounded-xl bg-sky-500/10 text-sky-400">ğŸ“Š å„€è¡¨æ¿ç¸½è¦½</button>
            <button class="w-full text-left px-4 py-3 rounded-xl text-slate-500 cursor-not-allowed">ğŸ‘¥ ç©å®¶ç®¡ç†</button>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col">
        <header class="h-16 border-b border-slate-800 flex items-center justify-between px-8 bg-slate-900/50">
            <div class="text-lg font-semibold" id="page-title">æ•¸æ“šçµ±è¨ˆ</div>
            <div id="auth-status" class="text-sm text-slate-400">æª¢æŸ¥æ¬Šé™ä¸­...</div>
        </header>

        <div id="content-area" class="flex-1 overflow-y-auto p-8">
            <div id="loading-state" class="flex flex-col items-center justify-center h-64 space-y-4">
                <div class="loader"></div>
                <p class="text-slate-400">æ­£åœ¨ç²å–å¯¦æ™‚æ•¸æ“š...</p>
                <p id="debug-info" class="text-xs text-slate-600 font-mono"></p>
            </div>
        </div>
    </main>

    <div id="toast-container" class="fixed top-6 right-6 z-50"></div>

    <script>
        // ğŸ› ï¸ è¨­å®šå€ï¼šç¢ºä¿é€™è£¡çš„è·¯å¾‘è·Ÿ index.js è£¡ router.get çš„ä¸€è‡´
        const API_PATH = '/api/admin/dashboard'; 

        // 1. å–å¾— SessionID (å¾ Cookie æˆ– LocalStorage)
        function getSessionId() {
            return localStorage.getItem('sessionId') || ''; 
        }

        // 2. ç²å–æ•¸æ“š
        async function loadDashboard() {
            const debug = document.getElementById('debug-info');
            debug.innerText = `æ­£åœ¨è«‹æ±‚: ${API_PATH}...`;

            try {
                const response = await fetch(API_PATH, {
                    headers: { 'session-id': getSessionId() }
                });

                // å¦‚æœ 401 æˆ– 403ï¼Œä»£è¡¨æ²’ç™»å…¥
                if (response.status === 401 || response.status === 403) {
                    document.getElementById('content-area').innerHTML = `
                        <div class="bg-rose-500/10 border border-rose-500/20 p-6 rounded-2xl text-center">
                            <p class="text-rose-500 font-bold">âŒ æ¬Šé™ä¸è¶³</p>
                            <p class="text-slate-400 mt-2">è«‹å…ˆä»¥ç®¡ç†å“¡å¸³è™Ÿç™»å…¥ç³»çµ±</p>
                            <button onclick="window.location.href='/login.html'" class="mt-4 px-4 py-2 bg-rose-500 rounded-lg">å‰å¾€ç™»å…¥</button>
                        </div>`;
                    return;
                }

                const data = await response.json();
                
                if (data.success) {
                    renderDashboard(data.stats);
                    document.getElementById('auth-status').innerText = 'ç®¡ç†å“¡é€£ç·šä¸­';
                } else {
                    throw new Error(data.error || 'æœªçŸ¥éŒ¯èª¤');
                }
            } catch (error) {
                console.error('API Error:', error);
                debug.innerText = `éŒ¯èª¤åŸå› : ${error.message}`;
                showToast('è³‡æ–™è¼‰å…¥å¤±æ•—: ' + error.message, 'error');
            }
        }

        // 3. æ¸²æŸ“ UI
        function renderDashboard(stats) {
            const container = document.getElementById('content-area');
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                    <div class="glass-card p-8 rounded-3xl">
                        <p class="text-slate-400 text-sm mb-1">ç¸½ç©å®¶æ•¸</p>
                        <h3 class="text-4xl font-bold text-sky-400">${stats.totalPlayers || 0}</h3>
                    </div>
                    <div class="glass-card p-8 rounded-3xl">
                        <p class="text-slate-400 text-sm mb-1">ä»Šæ—¥æµæ°´</p>
                        <h3 class="text-4xl font-bold text-emerald-400">$${stats.todayRevenue || 0}</h3>
                    </div>
                </div>
                <div class="glass-card p-8 rounded-3xl">
                    <h3 class="font-bold mb-6">ç‡Ÿæ”¶è¶¨å‹¢</h3>
                    <div class="chart-container"><canvas id="revenueChart"></canvas></div>
                </div>
            `;
            
            window.requestAnimationFrame(() => initChart(stats.revenueHistory || []));
        }

        function initChart(history) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: history.map(h => h.date || ''),
                    datasets: [{
                        label: 'ç‡Ÿæ”¶',
                        data: history.map(h => h.amount || 0),
                        borderColor: '#38bdf8',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(56, 189, 248, 0.1)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const div = document.createElement('div');
            div.className = `px-6 py-3 rounded-xl mb-2 ${type === 'error' ? 'bg-rose-500' : 'bg-sky-600'}`;
            div.innerText = msg;
            container.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>