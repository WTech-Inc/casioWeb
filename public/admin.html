<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å¿«æ´»å¨›æ¨‚åŸ | æ ¸å¿ƒæ¬Šé™æ§åˆ¶å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');
        body { background-color: #020617; font-family: 'Plus Jakarta Sans', sans-serif; color: #e2e8f0; }
        .terminal-font { font-family: 'Fira Code', monospace; }
        .glass { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(56, 189, 248, 0.1); }
        .neon-border { border: 1px solid rgba(56, 189, 248, 0.3); box-shadow: 0 0 15px rgba(56, 189, 248, 0.1); }
        .nav-active { background: linear-gradient(90deg, rgba(56, 189, 248, 0.15) 0%, transparent 100%); border-left: 4px solid #38bdf8; color: #38bdf8; }
        /* è‡ªå®šç¾©æŒ‰éˆ•éŸ³æ•ˆæ„Ÿ(è¦–è¦º) */
        .btn-action { transition: all 0.1s active { transform: scale(0.95); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-80 bg-[#070d19] border-r border-slate-800 flex flex-col">
        <div class="p-8">
            <div class="flex items-center space-x-3 mb-2">
                <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                <span class="text-xs font-bold text-slate-500 tracking-widest uppercase">Live System</span>
            </div>
            <h1 class="text-2xl font-black text-white italic tracking-tighter">JOYFUL <span class="text-sky-500">ADMIN</span></h1>
        </div>

        <nav class="flex-1 px-4">
            <div class="text-[10px] text-slate-600 font-bold px-4 mb-2 uppercase">ä¸»çŸ©é™£</div>
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-active w-full flex items-center px-4 py-4 mb-1 rounded-r-xl transition text-sm">
                <i class="fas fa-microchip mr-3"></i> æ•¸æ“šå„€è¡¨æ¿
            </button>
            <button onclick="switchTab('users')" id="nav-users" class="w-full flex items-center px-4 py-4 mb-1 rounded-r-xl text-slate-400 hover:text-sky-400 transition text-sm">
                <i class="fas fa-user-secret mr-3"></i> ç©å®¶å¤§å»³æ§åˆ¶
            </button>
            <div class="text-[10px] text-slate-600 font-bold px-4 mt-6 mb-2 uppercase">æ•¸æ“šæ ¸å¿ƒ</div>
            <button onclick="switchTab('games')" id="nav-games" class="w-full flex items-center px-4 py-4 mb-1 rounded-r-xl text-slate-400 hover:text-sky-400 transition text-sm">
                <i class="fas fa-dice mr-3"></i> è³ ç‡èˆ‡åœ–æ¨™ç®¡ç†
            </button>
            <button onclick="switchTab('database')" id="nav-database" class="w-full flex items-center px-4 py-4 mb-1 rounded-r-xl text-slate-400 hover:text-sky-400 transition text-sm">
                <i class="fas fa-database mr-3"></i> è³‡æ–™åº«ç¶­è­·
            </button>
        </nav>

        <div class="p-6 bg-slate-900/40">
            <button onclick="logout()" class="w-full py-3 rounded-lg border border-rose-500/30 text-rose-500 text-sm font-bold hover:bg-rose-500 hover:text-white transition shadow-lg shadow-rose-500/5">
                <i class="fas fa-lock-open mr-2"></i> çµ‚æ­¢æœƒè©±
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col">
        <header class="h-20 glass flex items-center justify-between px-10">
            <div class="flex items-center space-x-4">
                <i class="fas fa-terminal text-sky-500"></i>
                <div class="terminal-font text-xs text-sky-500/70" id="terminal-path">joyful-server:~/admin/dashboard</div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right">
                    <p class="text-xs text-slate-500">Node.js SQLite V3</p>
                    <p class="text-xs font-bold text-white">ç®¡ç†è€…: Root</p>
                </div>
                <div class="w-10 h-10 bg-sky-500/20 rounded-full flex items-center justify-center border border-sky-500/50">
                    <i class="fas fa-user-shield text-sky-400"></i>
                </div>
            </div>
        </header>

        <div id="content-area" class="flex-1 overflow-y-auto p-8 space-y-6">
            </div>
    </main>

    <div id="modal-overlay" class="fixed inset-0 bg-black/90 backdrop-blur-md z-50 hidden flex items-center justify-center">
        <div class="glass neon-border w-[450px] p-8 rounded-3xl" id="modal-content"></div>
    </div>

    <script>
        const BASE_URL = '/api/admin'; // åš´æ ¼å°é½Šä½ çš„è¦æ±‚
        const getHeaders = () => ({ 'session-id': localStorage.getItem('sessionId'), 'Content-Type': 'application/json' });

        // 1. åˆå§‹åŒ–
        window.onload = () => switchTab('dashboard');

        // 2. åˆ‡æ›é‚è¼¯
        async function switchTab(tab) {
            document.querySelectorAll('nav button').forEach(b => b.className = b.className.replace('nav-active', '').replace('text-sky-400', 'text-slate-400'));
            document.getElementById(`nav-${tab}`).classList.add('nav-active');
            document.getElementById('terminal-path').innerText = `joyful-server:~/admin/${tab}`;

            const container = document.getElementById('content-area');
            container.innerHTML = '<div class="h-full flex items-center justify-center"><i class="fas fa-circle-notch fa-spin text-4xl text-sky-500"></i></div>';

            try {
                const res = await fetch(`${BASE_URL}/dashboard`, { headers: getHeaders() });
                const data = await res.json();
                
                if (tab === 'dashboard') renderDashboard(data.stats);
                else if (tab === 'users') renderUsers(data.recentUsers);
                else if (tab === 'games') renderGames(); // éœ€å‘¼å« settings/stats API
                else if (tab === 'database') renderDatabase();
            } catch (err) {
                container.innerHTML = `<div class="p-10 glass border-rose-500/50 text-rose-500">ç³»çµ±ä¸­æ–·: ${err.message}</div>`;
            }
        }

        // --- å„€è¡¨æ¿æ¸²æŸ“ ---
        function renderDashboard(stats, users) {
    // ğŸ›¡ï¸ é˜²å‘†æ©Ÿåˆ¶ï¼šå¦‚æœ stats æ˜¯ undefinedï¼Œå°±è‡ªå‹•çµ¦å®ƒé è¨­å€¼
    const safeStats = stats || {};
    
    // ç¢ºä¿æ¯å€‹æ•¸å€¼éƒ½æœ‰ fallback (å¦‚æœä¸å­˜åœ¨å°±é¡¯ç¤º 0)
    const todayRevenue = safeStats.todayRevenue || 0;
    const totalPlayers = safeStats.totalPlayers || 0;
    const todayBets    = safeStats.todayBets || 0;
    const history      = safeStats.revenueHistory || [];

    const content = document.getElementById('content-area');
    content.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            ${card("ä»Šæ—¥æµæ°´", `$${todayRevenue.toLocaleString()}`, "fa-sack-dollar", "text-emerald-400")}
            ${card("ç¸½ç©å®¶æ•¸", totalPlayers, "fa-users", "text-sky-400")}
            ${card("ä»Šæ—¥ä¸‹æ³¨æ•¸", todayBets, "fa-dice", "text-purple-400")}
            ${card("ç³»çµ±ç•°å¸¸æ•¸", 0, "fa-circle-exclamation", "text-rose-400")}
        </div>
        <div class="glass p-8 rounded-3xl h-[400px]">
            <h3 class="text-sm font-bold text-slate-400 mb-4 tracking-widest">
                <i class="fas fa-wave-square mr-2"></i> 24H ç‡Ÿæ”¶æ³¢å‹•åœ–è­œ
            </h3>
            <canvas id="mainChart"></canvas>
        </div>
    `;
    
    // åˆå§‹åŒ–åœ–è¡¨
    initChart(history);
}

        // --- ç©å®¶ç®¡ç†ï¼šå¥½ç©çš„åŠŸèƒ½åœ¨é€™è£¡ ---
        function renderUsers(users) {
            document.getElementById('content-area').innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold tracking-tighter">ç©å®¶å¤§å»³é™£åˆ—</h3>
                    <div class="text-xs text-slate-500">é»æ“Šç©å®¶é€²è¡Œã€Œç‰¹æ®Šå¹²é ã€</div>
                </div>
                <div class="glass rounded-2xl overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-900/80 text-slate-500 text-[10px] uppercase">
                            <tr>
                                <th class="p-5">ç©å®¶ç‰¹å¾µ (Username)</th>
                                <th class="p-5">è³‡ç”¢ (Chips)</th>
                                <th class="p-5">ç™»éŒ„åºè™Ÿ</th>
                                <th class="p-5">å¿«æ·æ¬Šé™</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(u => `
                                <tr class="border-b border-slate-800/50 hover:bg-sky-500/5 transition">
                                    <td class="p-5 font-bold text-white">${u.username}</td>
                                    <td class="p-5 text-emerald-400 font-mono">$${u.chips.toLocaleString()}</td>
                                    <td class="p-5 text-slate-500 text-xs">${u.player_id}</td>
                                    <td class="p-5 flex space-x-2">
                                        <button onclick="instantRich('${u.player_id}', '${u.username}')" class="px-3 py-1 bg-amber-500/10 text-amber-500 border border-amber-500/20 rounded-md text-xs hover:bg-amber-500 hover:text-white transition">ä¸€éµæš´å¯Œ</button>
                                        <button onclick="punish('${u.player_id}')" class="px-3 py-1 bg-rose-500/10 text-rose-500 border border-rose-500/20 rounded-md text-xs hover:bg-rose-500 hover:text-white transition">æ­¸é›¶æ‡²ç½°</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // --- éŠæˆ²åœ–æ¨™ç®¡ç† ---
        async function renderGames() {
            const res = await fetch(`${BASE_URL}/settings/stats`, { headers: getHeaders() });
            const { stats } = await res.json();
            document.getElementById('content-area').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass p-8 rounded-3xl">
                        <h3 class="font-bold text-sky-400 mb-6 uppercase tracking-widest text-xs">åœ–æ¨™åˆ†é¡åˆ†ä½ˆ</h3>
                        <div class="space-y-4">
                            ${stats.iconsByCategory.map(c => `
                                <div>
                                    <div class="flex justify-between text-xs mb-1">
                                        <span>${c.category}</span>
                                        <span>${c.count} é …</span>
                                    </div>
                                    <div class="w-full h-1 bg-slate-800 rounded-full overflow-hidden">
                                        <div class="h-full bg-sky-500" style="width: ${(c.count / stats.totalIcons * 100)}%"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="glass p-8 rounded-3xl border-purple-500/20">
                         <h3 class="font-bold text-purple-400 mb-4 uppercase tracking-widest text-xs">éŠæˆ²ä¼ºæœå™¨æ ¸å¿ƒ</h3>
                         <div class="flex items-center justify-between p-4 bg-slate-900 rounded-xl mb-2">
                            <span class="text-sm">ç™¾å®¶æ¨‚ä¼ºæœå™¨</span>
                            <span class="text-[10px] px-2 py-1 bg-emerald-500/10 text-emerald-500 rounded">HEALTHY</span>
                         </div>
                         <div class="flex items-center justify-between p-4 bg-slate-900 rounded-xl">
                            <span class="text-sm">è€è™æ©Ÿäº‚æ•¸ç”Ÿæˆå™¨</span>
                            <span class="text-[10px] px-2 py-1 bg-emerald-500/10 text-emerald-500 rounded">HEALTHY</span>
                         </div>
                    </div>
                </div>
            `;
        }

        // --- è³‡æ–™åº«ç¶­è­·ï¼šå¥½ç©é»çš„æ—¥èªŒç›£æ§ ---
        function renderDatabase() {
            document.getElementById('content-area').innerHTML = `
                <div class="glass p-8 rounded-3xl mb-6">
                    <h3 class="text-xs font-bold text-slate-500 uppercase mb-4 tracking-widest">å¯¦æ™‚æ“ä½œæ—¥èªŒ (Read-only)</h3>
                    <div class="bg-black/50 p-6 rounded-xl terminal-font text-[11px] text-emerald-500/80 h-48 overflow-y-auto space-y-1">
                        <div>[${new Date().toLocaleTimeString()}] INFO: è³‡æ–™åº«é€£æ¥æ± åˆå§‹åŒ–å®Œæˆ...</div>
                        <div>[${new Date().toLocaleTimeString()}] WARN: åµæ¸¬åˆ° 127.0.0.1 å˜—è©¦å­˜å–ç®¡ç†æ¬Šé™...</div>
                        <div class="animate-pulse">[${new Date().toLocaleTimeString()}] SUCCESS: Root ç®¡ç†å“¡é€²å…¥æ§åˆ¶çŸ©é™£...</div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button class="glass p-6 rounded-2xl hover:border-sky-500 transition text-left group">
                        <i class="fas fa-file-export text-sky-500 mb-2"></i>
                        <div class="text-sm font-bold">ä¸‹è¼‰ SQL é¡åƒå‚™ä»½</div>
                    </button>
                    <button class="glass p-6 rounded-2xl hover:border-rose-500 transition text-left group">
                        <i class="fas fa-trash-alt text-rose-500 mb-2"></i>
                        <div class="text-sm font-bold">å¼·åˆ¶æ¸…é™¤æ‰€æœ‰ç„¡æ•ˆ Session</div>
                    </button>
                </div>
            `;
        }

        // --- ç‰¹æ®Šæ“ä½œåŠŸèƒ½ ---
        function instantRich(id, name) {
            openModal(`
                <h3 class="text-xl font-black italic mb-4">çµ¦äºˆã€Œä¸€éµæš´å¯Œã€ç¦åˆ©</h3>
                <p class="text-sm text-slate-400 mb-6">å°‡ç‚ºç©å®¶ <span class="text-sky-400 font-bold">${name}</span> æ³¨å…¥ <span class="text-emerald-400">$10,000,000</span> ç±Œç¢¼ã€‚</p>
                <div class="flex space-x-3">
                    <button onclick="closeModal()" class="flex-1 py-3 rounded-xl bg-slate-800 text-xs uppercase font-bold">å–æ¶ˆ</button>
                    <button onclick="executeAction('${id}', 10000000)" class="flex-1 py-3 rounded-xl bg-emerald-500 text-black text-xs font-black uppercase">ç«‹å³æ³¨å…¥</button>
                </div>
            `);
        }

        function punish(id) {
            openModal(`
                <h3 class="text-xl font-black italic mb-4 text-rose-500">æ­¸é›¶æ‡²ç½°</h3>
                <p class="text-sm text-slate-400 mb-6">é€™å°‡æ¸…ç©ºç©å®¶çš„æ‰€æœ‰è³‡ç”¢ã€‚ç¢ºå®šåŸ·è¡Œï¼Ÿ</p>
                <div class="flex space-x-3">
                    <button onclick="closeModal()" class="flex-1 py-3 rounded-xl bg-slate-800 text-xs uppercase font-bold">å–æ¶ˆ</button>
                    <button onclick="executeAction('${id}', 0)" class="flex-1 py-3 rounded-xl bg-rose-600 text-white text-xs font-black uppercase">ç¢ºèªæ‡²ç½°</button>
                </div>
            `);
        }

        async function executeAction(playerId, amount) {
            // æ³¨æ„ï¼šé€™è£¡å‡è¨­ä½ åœ¨ admin.js æœ‰å¯¦ä½œ /update-chips è·¯ç”±
            try {
                const res = await fetch(`${BASE_URL}/update-chips`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ playerId, amount })
                });
                const data = await res.json();
                if (data.success) {
                    alert("æ“ä½œæˆåŠŸï¼ŒçŸ©é™£å·²æ›´æ–°ã€‚");
                    closeModal();
                    switchTab('users');
                } else {
                    alert("æ“ä½œå¤±æ•—: " + data.error);
                }
            } catch (e) {
                alert("ä¼ºæœå™¨æ‹’çµ•é€£ç·š");
            }
        }
        // --- æ ¸å¿ƒå·¥å…·å‡½æ•¸ï¼šç”¢ç”Ÿæ•¸æ“šå¡ç‰‡ HTML ---
function card(title, value, icon, colorClass) {
    return `
        <div class="glass p-6 rounded-2xl relative overflow-hidden shadow-lg border border-white/5">
            <i class="fas ${icon} absolute -right-2 -bottom-2 text-6xl opacity-5 transition-transform group-hover:scale-110"></i>
            <p class="text-slate-500 text-[10px] uppercase font-bold tracking-widest mb-1">${title}</p>
            <h3 class="text-2xl font-black ${colorClass}">${value}</h3>
        </div>
    `;
}

        // --- é€šç”¨å·¥å…· ---
        function openModal(html) {
            document.getElementById('modal-content').innerHTML = html;
            document.getElementById('modal-overlay').classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); }
        function initChart(history = []) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: history.map(h => h.date),
                    datasets: [{
                        label: 'Revenue',
                        data: history.map(h => h.amount),
                        borderColor: '#38bdf8',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(56, 189, 248, 0.05)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: 'rgba(255,255,255,0.05)' } }, x: { display: false } } }
            });
        }
        function logout() { localStorage.removeItem('sessionId'); location.href = '/login.html'; }
    </script>
</body>
</html>